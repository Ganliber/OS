# Chapter 3

[TOC]

## 3.1 BIOS

* 内存

  * RAM : 随机访问存储
  * ROM : 只读存储 （系统初始化代码）

* BIOS

  * 将加载程序从**磁盘的引导扇区（512 bytes）**加载到`0x7c00 `
  * 跳转到`CS:IP = 0000:7c00`
  * 此时将**控制权**转到磁盘上读取的程序：加载程序

* 加载程序

  * 将OS code and data 从硬盘加载到内存中
  * 将控制权移交给OS kernel code
  * 跳转到OS的**起始地址**

* BIOS 以中断调用的方式提供基本的`I/O`功能

  > Intel CPU ，这些功能只能在实模式下使用，保护模式即失效

  * int 10h : 字符显示
  * int 13h : 磁盘扇区读写
  * int 15h : 检测内存大小
  * int 16h : 键盘输入



## 3.2 系统启动流程

### 整体过程

1. BIOS：系统加电，BIOS初始化硬件
2. 主引导记录：由于计算机上可能不止有一个文件系统（双系统等）。
   * BIOS读取主引导扇区代码
3. 活动分区：
   * 主引导扇区代码读取**活动分区的引导扇区代码**
4. 加载程序`bootloader`
   * 引导扇区代码读取文件系统的加载程序

### 具体过程展开

1. CPU 初始化

   * CS:IP = 0xf000:fff0
   * 第一条指令为`jmp`
   * CPU 初始状态是**16位实模式**，CS:IP是16位寄存器
   * PC = 16*CS + IP
   * 最大地址空间为1MB

2. BIOS 初始化

   * 硬件自检`POST`
   * 检测系统中内存、显卡等关键部件的存在和工作状态
   * 查找并执行显卡等接口卡BIOS，进行设备初始化
   * 执行系统BIOS，进行系统检测
     * 检测、配置系统中安装的即插即用设备（USB等）。
   * 更新`CMOS`的扩展系统配置数据`ESCO`
   * 按指定启动顺序从软盘，硬盘或光驱启动

3. 主引导记录`MBR`格式

   > 共512 bytes

   * 启动代码：446 bytes
     * 检查分区表的正确性
     * 加载并跳转到**磁盘上的引导程序**
   * 硬盘分区表：64 bytes
     * 描述分区状态和位置
     * 每个分区描述信息占据 16 bytes
   * 对于所有的引导扇区都有结束标志字：2 bytes ( 55AA )
     * 主引导记录的有效标志

4. 活动分区的引导扇区格式

   * 跳转指令：跳转到启动代码
     * 该跳转指令与平台相关

   * 文件卷头：文件系统描述信息
   * 启动代码：跳转到加载程序
   * 结束标志：55AA

5. 加载程序`bootloader`

   > 不是直接加载内核

   1. 从**文件系统**中读取**启动配置信息**
      * 启动配置文件与OS类型相关
      * 决定加载kernel时选择的参数，模式（安全模式等等）之类的。
   2. 启动菜单：可选的操作系统内核列表和加载参数
   3. 操作系统内核：依据配置加载指定内核并跳转到内核执行

### 系统启动规范

* BIOS
  * 固化到计算机主板上的程序
  * 包括系统设置，自检程序，系统自启动程序
  * 变体：BIOS-MBR，BIOS-GPT，PXE（网络启动标准）
* UEFI : 统一可扩展固件接口
  * 接口标准
  * 在所有平台上一致的操作系统启动服务



## 3.3 中断，异常，系统调用比较







## 3.4 系统调用



## 3.5 系统调用示例



## 3.6 ucore + 系统调用代码





















